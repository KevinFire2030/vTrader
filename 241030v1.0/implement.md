# vTrader v1.0 구현 계획

## 1. 구현 순서

### 1.1 핵심 모듈 구현
1. TimeSync (1일차)
   - [x] 기본 구조 작성
   - [ ] 서버 시간 동기화 구현
   - [ ] 정각 대기 기능 구현
   - [ ] 단위 테스트 작성

2. DataFeed (2-3일차)
   - [x] 기본 구조 작성
   - [ ] 초기 데이터 로드 구현
   - [ ] 실시간 업데이트 구현
   - [ ] 데이터 무결성 검증
   - [ ] 단위 테스트 작성

3. Position (3-4일차)
   - [x] 기본 구조 작성
   - [ ] 포지션 정보 관리 구현
   - [ ] MT5 포지션 동기화
   - [ ] 손절가 관리 구현
   - [ ] 단위 테스트 작성

4. Pyramid (4-5일차)
   - [x] 기본 구조 작성
   - [ ] 피라미딩 주문 생성
   - [ ] 주문 상태 관리
   - [ ] 손절가 재조정
   - [ ] 단위 테스트 작성

5. Technical (5-6일차)
   - [x] 기본 구조 작성
   - [ ] EMA 계산 구현
   - [ ] ATR 계산 구현
   - [ ] 거래 신호 생성
   - [ ] 단위 테스트 작성

### 1.2 유틸리티 구현
1. MT5Wrapper (6일차)
   - [x] 기본 구조 작성
   - [ ] 연결 관리 구현
   - [ ] 에러 처리 구현
   - [ ] 재연결 로직 구현
   - [ ] 단위 테스트 작성

2. Logger (7일차)
   - [x] 기본 구조 작성
   - [ ] 로그 레벨 구현
   - [ ] 파일 로깅 구현
   - [ ] 로그 포맷 정의
   - [ ] 단위 테스트 작성

3. Config (7일차)
   - [x] 기본 구조 작성
   - [ ] YAML 설정 파일 구현
   - [ ] 환경별 설정 구현
   - [ ] 설정 검증 구현
   - [ ] 단위 테스트 작성

### 1.3 통합 테스트
1. 모듈 통합 (8일차)
   - [ ] TimeSync + DataFeed 통합
   - [ ] Position + Pyramid 통합
   - [ ] Technical + DataFeed 통합
   - [ ] 통합 테스트 작성

2. 시스템 통합 (9일차)
   - [ ] 전체 모듈 통합
   - [ ] 에러 처리 검증
   - [ ] 성능 테스트
   - [ ] 시스템 테스트 작성

### 1.4 최적화 및 안정화
1. 성능 최적화 (10일차)
   - [ ] 메모리 사용량 최적화
   - [ ] CPU 사용량 최적화
   - [ ] 응답 시간 최적화
   - [ ] 성능 테스트

2. 안정성 강화 (10일차)
   - [ ] 예외 처리 보강
   - [ ] 로깅 강화
   - [ ] 장애 복구 테스트
   - [ ] 스트레스 테스트

## 2. 테스트 계획

### 2.1 단위 테스트
- 각 모듈별 테스트 케이스 작성
- 경계값 테스트
- 예외 상황 테스트
- 성능 테스트

### 2.2 통합 테스트
- 모듈간 인터페이스 테스트
- 데이터 흐름 테스트
- 에러 전파 테스트
- 동시성 테스트

### 2.3 시스템 테스트
- 전체 시스템 동작 테스트
- 장시간 운영 테스트
- 장애 상황 테스트
- 복구 테스트

## 3. 구현 세부사항

[!NOTE] TimeSync 구현
- 서버 시간 동기화
- 정각 대기 기능
- 시간 오차 보정

[!NOTE] DataFeed 구현
- 초기 데이터 로드
- 실시간 업데이트
- 데이터 검증

[!NOTE] Position 구현
- 포지션 상태 관리
- MT5 동기화
- 손절가 관리

[!NOTE] Pyramid 구현
- 피라미딩 주문 생성
- 주문 상태 관리
- 손절가 재조정

## 2. 구현 내용

### 2.1 TimeSync 구현 결과
1. 테스트 결과
   - [x] 서버 시간 조회 테스트 통과
   - [x] 오프셋 계산 테스트 통과
   - [x] 동기화 상태 확인 테스트 통과
   - [x] 정각 대기 테스트 (skip)

2. 발견된 문제점
   - MT5 연결 상태 확인 로직 필요
   - 재연결시 오프셋 재계산 필요
   - 로깅 기능 추가 필요

3. 개선 사항
   - MT5Wrapper 의존성 추가
   - 로거 의존성 추가
   - 에러 처리 강화

### 2.2 DataFeed 구현 결과
1. 테스트 결과
   - [x] 초기 데이터 로드 테스트 통과
   - [x] 데이터 업데이트 테스트 통과
   - [x] 데이터 무결 테스트 통과
   - [x] 1분 업데이트 테스트 통과

2. 발견된 문제점
   - 1마다 업데이트 검증 부족
   - 데이터 누락 가능성 존재
   - 메모리 사용량 모니터링 필요

3. 개선 사항
   - 실시간 업데이트 검증 강화
   - 데이터 백업 메커니즘 추가
   - 성능 모니터링 추가

### 2.3 다음 단계 준비사항
1. Position 모듈 구현 전
   - MT5Wrapper 구현 필요
   - 로거 구현 필요
   - Config 구현 필요

2. 필요한 설정
   - 계좌 설정
   - 리스크 관리 파라미터
   - 심볼별 설정

3. 테스트 환경
   - 테스트 계정 준비
   - 테스트 데이터 준비
   - 모의 거래 환경 구성

### 2.4 우선순위
1. 즉시 해결 필요
   - MT5Wrapper 구현
   - 로거 구현
   - Config 구현

2. Position 모듈 구현 전
   - TimeSync 개선사항 적용
   - DataFeed 개선사항 적용
   - 테스트 코드 보강

3. 향후 과제
   - 성능 모니터링 추가
   - 장애 복구 메커니즘 구현
   - 백업 시스템 구현

### 2.5 Config 구현 결과

1. 구현 완료 항목
   - [x] YAML 설정 파일 로드
   - [x] 설정값 검증
   - [x] 기본값 처리
   - [x] 단위 테스트 작성

2. 주요 기능
   - 설정 파일 로드 및 검증
     * YAML 파일 파싱
     * 필수 섹션 확인
     * 설정값 타입 검증
   
   - 설정값 접근 메서드
     * get_symbols(): 거래 심볼 목록
     * get_risk_params(): 리스크 관리 파라미터
     * get_strategy_params(): 전략 파라미터
     * get_mt5_params(): MT5 설정

3. 테스트 결과
   - [x] 설정 파일 로드 테스트 통과
   - [x] 거래 심볼 조회 테스트 통과
   - [x] 리스크 파라미터 테스트 통과
   - [x] 전략 파라미터 테스트 통과
   - [x] MT5 파라미터 테스트 통과

4. 개선 필요 사항
   - [ ] 환경별 설정 파일 분리 (dev/test/prod)
   - [ ] 설정값 실시간 리로드 기능
   - [ ] 설정값 변경 이력 관리
   - [ ] 보안 관련 설정 암호화

### 2.6 Logger 구현 계획

1. 구현 목표
   - 로그 레벨별 출력
   - 파일 및 콘솔 로깅
   - 로그 포맷 정의
   - 로그 파일 관리

2. 주요 기능
   - 로그 레벨
     * DEBUG: 상세 디버깅 정보
     * INFO: 일반적인 정보
     * WARNING: 경고 메시지
     * ERROR: 에러 메시지
     * CRITICAL: 치명적 오류
   
   - 로그 포맷
     * 시간: [2024-03-26 14:50:00.123]
     * 레벨: [INFO]
     * 모듈: [TimeSync]
     * 메시지: 서버 시간 동기화 완료
   
   - 파일 관리
     * 일별 로그 파일
     * 파일 크기 제한
     * 오래된 로그 삭제

3. 구현 순서
   - [x] 기본 구조 작성
   - [ ] 로그 레벨 구현
   - [ ] 파일 로깅 구현
   - [ ] 로그 포맷 정의
   - [ ] 단위 테스트 작성

### 2.7 Logger 구현 결과

1. 테스트 결과
   - [x] 로그 파일 생성 테스트 통과
   - [x] 로그 레벨별 출력 테스트 통과
   - [x] 파일 로테이션 테스트 통과
   - [x] 로그 포맷 테스트 통과

2. 발견된 문제점
   - 로그 파일 핸들러가 제대로 닫히지 않는 문제
   - 파일 권한 문제 (Windows 환경)
   - 로그 포맷 문자열 오류
   - 로그 파일 삭제시 접근 오류

3. 해결 방안
   - cleanup 메서드 추가로 핸들러 정리
   - 파일 접근 권한 검사 추가
   - 로그 포맷 문자열 수정
   - 파일 핸들러 관리 개선

4. 개선 사항
   - 로그 레벨 설정 기능 추가
   - 로그 파일 압축 기능 추가
   - 로그 순환 정책 개선
   - 에러 로그 분리 저장

### 2.8 MT5Wrapper 구현 계획

1. 구현 목표
   - MT5 API 래핑
   - 연결 관리 자동화
   - 에러 처리 표준화
   - 재시도 메커니즘 구현

2. 주요 기능
   - 연결 관리
     * 초기화/종료
     * 연결 상태 모니터링
     * 자동 재연결
     * 타임아웃 처리
   
   - 데이터 조회
     * 가격 데이터 요청
     * 틱 데이터 조회
     * 심볼 정보 조회
     * 계좌 정보 조회
   
   - 주문 관리
     * 주문 실행
     * 주문 수정
     * 주문 취소
     * 포지션 조회
   
   - 에러 처리
     * 에러 코드 매핑
     * 재시도 로직
     * 로깅 연동
     * 복구 전략

3. 구현 순서
   - [x] 기본 구조 작성
   - [ ] 연결 관리 구현
   - [ ] 데이터 조회 구현
   - [ ] 주문 관리 구현
   - [ ] 에러 처리 구현
   - [ ] 단위 테스트 작성

4. 테스트 계획
   - 연결 테스트
     * 초기화/종료 테스트
     * 재연결 테스트
     * 타임아웃 테스트
   
   - 데이터 테스트
     * 가격 데이터 조회
     * 틱 데이터 조회
     * 심볼 정보 조회
   
   - 주문 테스트
     * 주문 실행 테스트
     * 주문 수정 테스트
     * 주문 취소 테스트
   
   - 에러 테스트
     * 연결 끊김 테스트
     * 재시도 동작 테스트
     * 복구 프로세스 테스트

5. 예상 문제점
   - 연결 불안정성
   - 데이터 지연
   - 주문 실패
   - 에러 처리 복잡성

6. 해결 방안
   - 연결 모니터링 강화
   - 데이터 캐싱 구현
   - 주문 재시도 로직
   - 표준 에러 처리

### 2.9 MT5Wrapper 구현 결과

1. 구현된 기능
   - [x] MT5 연결 관리
     * 초기화/종료
     * 연결 상태 확인
     * 자동 재연결
   
   - [x] 데이터 조회
     * 서버 시간 조회
     * 봉 데이터 조회
     * 포지션 조회
   
   - [x] 주문 관리
     * 주문 실행
     * 주문 수정
     * 주문 취소

2. 주요 메서드
   ```python
   # 연결 관리
   initialize(): bool
   shutdown(): void
   check_connection(): bool
   
   # 데이터 조회
   get_server_time(): Optional[float]
   get_candles(): Optional[List[Dict]]
   get_positions(): List[Dict]
   
   # 주문 관리
   place_order(): Optional[Dict]
   modify_order(): bool
   cancel_order(): bool
   ```

3. 에러 처리
   - 재시도 메커니즘
     * 최대 3회 재시도
     * 1초 간격으로 재시도
     * 실패 시 로그 기록
   
   - 연결 복구
     * 연결 끊김 감지
     * 자동 재연결 시도
     * 연결 상태 모니터링

4. 개선 필요 사항
   - [ ] 추가 MT5 함수 래핑
     * 계좌 정보 조회
     * 거래 내역 조회
     * 심볼 정보 조회
   
   - [ ] 에러 처리 강화
     * 에러 코드 매핑
     * 상세 에러 메시지
     * 복구 전략 개선
   
   - [ ] 성능 최적화
     * 데이터 캐싱
     * 배치 처리
     * 메모리 관리

### 2.10 추후 구현 가능한 기능들

1. MT5Wrapper 추가 기능
   - 계정 관리
     * account_info(): 계좌 정보 조회
     * terminal_info(): 터미널 정보 조회
   
   - 심볼 관리
     * symbols_total(): 전체 심볼 수 조회
     * symbols_get(): 심볼 목록 조회
     * symbol_info(): 심볼 정보 조회
     * symbol_select(): 마켓워치 심볼 ��리
   
   - 주문 계산
     * order_calc_margin(): 증거금 계산
     * order_calc_profit(): 수익 계산
     * order_check(): 주문 유효성 검사
   
   - 거래 내역
     * history_orders_total(): 주문 내역 수
     * history_orders_get(): 주문 내역 조회
     * history_deals_total(): 거래 내역 수
     * history_deals_get(): 거래 내역 조회

2. 구현 우선순위
   - 1순위: 필수 기능
     * 계좌 정보 조회
     * 거래 내역 조회
     * 심볼 정보 조회
   
   - 2순위: 확장 기능
     * 주문 계산 기능
     * 마켓워치 관리
     * 터미널 정보 조회
   
   - 3순위: 부가 기능
     * 상세 내역 조회
     * 통계 데이터 수집
     * 성과 분석 기능

3. 구현시 고려사항
   - 에러 처리 강화
   - 데이터 캐싱 구현
   - 성능 최적화
   - 메모리 관리
   - 로깅 시스템 연동

## 3. 참고 자료

### 3.1 MT5 Python API 문서
- [MetaTrader5 Python Integration](https://www.mql5.com/en/docs/python_metatrader5)
  * 초기화/종료 함수
  * 계정/터미널 정보
  * 심볼 관리 함수
  * 주문 관련 함수
  * 거래 내역 조회
  * 데이터 요청 함수

### 3.2 Backtrader 핵심 클래스
...